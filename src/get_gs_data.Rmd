
# Setup

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Set locale (so we use UTF-8 character encoding):

```{r}
# This works on Mac OS X, might not work on other OS
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")
```

Load libraries:

```{r}
library(googlesheets)
library(tidyverse) # To transform data
library(magrittr)  # For %<>% pipes
```

Set file paths (all paths should be relative to this script):

```{r}
# Raw file:
dwc_raw_file = "../data/raw/gapminder.csv"

# Processed files:
dwc_test_file = "../data/processed/gapminder.csv"
```

# Read and pre-process raw data

Register the spreadsheet:

```{r}
raw_data_file = gs_title("TEST gapminder data")
```

Read the data in the worksheet `gapminder`:

```{r}
raw_data <- raw_data_file %>% gs_read("gapminder")
```

Save `raw_data` as a .csv file:

```{r}
write.csv(raw_data, file = dwc_raw_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```

Add prefix `raw_` to all column names to avoid name clashes with Darwin Core terms:

```{r}
colnames(raw_data) <- paste0("raw_", colnames(raw_data))
```

Generate `processed`:

```{r}
processed <- raw_data
```


# Basic processing

Add a new column to raw_data:

```{r}
processed %<>% mutate(country_new = raw_country) 
```

Use `case_when()`:

```{r}
processed %<>% mutate(after_2000 = case_when(
  raw_year < 2000 ~ "NO",
  raw_year > 2000 ~ "YES")) 
```

# Post-processing:

Remove original columns

```{r}
processed %<>% select(-starts_with("raw_"))
```

Export dataframe

```{r}
write.csv(processed, file = dwc_test_file, na = "", row.names = FALSE, fileEncoding = "UTF-8")
```
